
from collections import defaultdict
import numpy as np
import re

test = '''Tile 2311:
..##.#..#.
##..#.....
#...##..#.
####.#...#
##.##.###.
##...#.###
.#.#.#..##
..#....#..
###...#.#.
..###..###

Tile 1951:
#.##...##.
#.####...#
.....#..##
#...######
.##.#....#
.###.#####
###.##.##.
.###....#.
..#.#..#.#
#...##.#..

Tile 1171:
####...##.
#..##.#..#
##.#..#.#.
.###.####.
..###.####
.##....##.
.#...####.
#.##.####.
####..#...
.....##...

Tile 1427:
###.##.#..
.#..#.##..
.#.##.#..#
#.#.#.##.#
....#...##
...##..##.
...#.#####
.#.####.#.
..#..###.#
..##.#..#.

Tile 1489:
##.#.#....
..##...#..
.##..##...
..#...#...
#####...#.
#..#.#.#.#
...#.#.#..
##.#...##.
..##.##.##
###.##.#..

Tile 2473:
#....####.
#..#.##...
#.##..#...
######.#.#
.#...#.#.#
.#########
.###.#..#.
########.#
##...##.#.
..###.#.#.

Tile 2971:
..#.#....#
#...###...
#.#.###...
##.##..#..
.#####..##
.#..####.#
#..#.#..#.
..####.###
..#.#.###.
...#.#.#.#

Tile 2729:
...#.#.#.#
####.#....
..#.#.....
....#..#.#
.##..##.#.
.#.####...
####.#.#..
##.####...
##..#.##..
#.##...##.

Tile 3079:
#.#.#####.
.#..######
..#.......
######....
####.#..#.
.#...#.##.
#.#####.##
..#.###...
..#.......
..#.###...'''

actual = '''Tile 1409:
##..#.#.#.
##........
#.#...##.#
#..#..#...
.......##.
##......##
..........
.........#
.#..##....
#.##...##.

Tile 2939:
......#.##
##.#......
...##...##
#.#.....##
#...#....#
.#..#....#
#.....##.#
..##.#...#
..#.#.#..#
#######..#

Tile 3347:
...##..#.#
.#......#.
.#........
#.....#...
#.....##..
##.......#
.....#....
......###.
#...#..##.
########.#

Tile 1297:
#..#.##.##
#..###...#
#.##......
...#.#...#
#.#......#
....#....#
.#..#.....
......##..
#.........
...#.##.##

Tile 3203:
####.#.#..
#.#.#.##..
#......###
#....###.#
.......#.#
#.........
#..#..##..
..##...#.#
#.....##..
#.##.#...#

Tile 1283:
####..#...
#.......##
#....#..#.
..##.....#
.#...#####
###...#...
..##....#.
.#.......#
.##.#.....
#.###..###

Tile 1879:
######.#..
..#.#....#
..#..##...
.#...#.#..
....#....#
....#.#.##
##.......#
#...#..#.#
..#.##....
#..####.#.

Tile 2293:
#.##.###.#
..#.....##
#...#.....
..##......
.#...#.#.#
#........#
.##...###.
###.#....#
...#......
.#..######

Tile 3079:
#.###.....
......#...
..##......
..#...#...
.#.#......
#....#...#
........##
..#..#...#
#..#......
#.#.#.###.

Tile 1069:
.#.##.....
...##...#.
###.#..##.
.#....#.##
......#.#.
#.#..#.##.
...#......
#..##...#.
##.##.....
#.#.##.#..

Tile 1229:
#.#...#..#
.........#
....#..##.
#.#...#..#
...###.#.#
##.##.....
...##....#
..#..#.###
..#......#
.##..#.#.#

Tile 3631:
###.....##
#.#.......
#.#.#..#.#
....#...##
#.###.#.#.
.....##.##
...#..###.
#..#...#.#
..#..##..#
.##.#.#..#

Tile 1747:
..##.....#
.#.....#.#
..........
..#.#.#..#
#...#.....
..##.#.#..
#....#..##
...#.....#
#.....##.#
..#.#####.

Tile 2531:
.#...##...
#....####.
##...##..#
#..#...#..
##....#...
.#....#.##
.........#
.#......#.
...#...#.#
##....#...

Tile 2203:
##..#...##
##..#.#..#
....##..#.
###.###...
.......#.#
#.....##.#
#.#....#..
.......#.#
...#.#....
##.#.####.

Tile 2777:
...#.##...
...#......
.#....##..
....#..#.#
#.....#..#
......##..
#....##.##
......#..#
#..##.##..
...#.#.###

Tile 3323:
#...##.#.#
..#.......
#......#..
.#..##...#
......##..
#....#..##
.......#.#
....#...#.
#.....#...
##..#.#..#

Tile 3319:
#....#.##.
##.....#.#
####......
..#.##..##
##....##.#
.......#.#
..######.#
#.#......#
#..#......
#..#.#..##

Tile 3313:
...#.##.##
........##
##..#...##
##.....#.#
##..#....#
.......#..
##.......#
#.#.......
.........#
#.#..###.#

Tile 2657:
.###..#..#
..#......#
.#...##...
#..#.....#
....#...##
#.........
...##.#...
.##....#.#
##...#....
#.####...#

Tile 1907:
#.#####.#.
##..#.##..
.....#.###
.#.#..##.#
.#.###...#
...####...
#..###....
##....#...
..#..#.#..
#...###.#.

Tile 3373:
#.#####...
..###.....
.##..#..##
....#...##
......#..#
..##.....#
....##.###
.#.#.....#
#..##.#...
.......###

Tile 3253:
##..###..#
##......##
##.......#
##.#......
##.......#
#........#
..##...###
#..###..#.
#.....###.
..#.##..##

Tile 2767:
......####
..#...####
..###.....
#...##...#
...#..#..#
.####....#
#...##...#
...##.####
#...##.#..
..#.....##

Tile 3761:
....######
.......###
.#.##.....
.......#..
..........
.#.#.....#
#........#
##.##...##
#......#.#
#.##.#..#.

Tile 1031:
...#.###.#
.#......#.
##...#..#.
#...#.....
#.....#.##
#.#...#..#
##..##.#..
.##.#..#..
..#.....##
.......#.#

Tile 1181:
####..#.##
.....###.#
..##..#...
...#.#..##
...#....#.
#.......##
...#....##
#..##.#..#
###...#...
#.##..#.#.

Tile 2887:
.####..#.#
.......#.#
#.#..#.#.#
#.##.....#
...#.#...#
###..#....
#...#.....
.....#....
###..#..#.
...###..#.

Tile 1381:
#...#..#.#
..........
....#...#.
..#..##...
........##
#.#.......
##........
.#..##...#
#..#......
########..

Tile 2621:
...#.####.
#...#..#..
#.#.....#.
..##.#..##
####..#...
.###.#..#.
##...##..#
#..#.#..#.
#..##.#...
#..###...#

Tile 1597:
##.##..###
.#...##...
..##....#.
.##.......
.##....#.#
#..#.#....
#........#
...#......
.#..###.##
...###.###

Tile 3533:
#.###.##.#
##.##...#.
##..#.#.##
.#.#..#.##
#.....#...
#..#...#.#
..###.#..#
.#....#.#.
#.........
#...#.#.##

Tile 1249:
.##.....##
#.....#.##
#..#..#.##
#.#.#...#.
......#...
.#...##...
##.#.....#
..###.....
#.......#.
#.######..

Tile 2843:
#.#.#.....
.......#.#
#.....###.
#.....##.#
...##.##.#
#...#.####
..#.#....#
.......#..
##.#..#.##
.##.##...#

Tile 1583:
..####.#..
##..#....#
###...##.#
#....#.##.
#..#......
##.......#
##.#...#..
....#.#..#
....#..#.#
....#.###.

Tile 3169:
...#.###..
.####.....
#.#.#..#..
#...#..#..
..........
##.#...#..
..........
#..#....##
#...#....#
..##.....#

Tile 1367:
......##..
.##.......
##.#..##.#
#...#.#...
#.###.#..#
#.#...#..#
.....#...#
.....#...#
#.#.#.#...
#....##...

Tile 2099:
..###.####
.####.###.
...#...#..
...##.##.#
#....##...
....#..#.#
...#...##.
#........#
#..#.#..#.
..##...##.

Tile 3613:
#.#.####..
###......#
.##..##...
##..##...#
#........#
.....#....
.......#..
.##.#.....
.##.#....#
####..#.##

Tile 3727:
..#.##.##.
#..#..##..
##........
#.......#.
.#.###.#..
.#....#...
#.........
#...#.#.#.
.#..#...##
.###.#.#..

Tile 3697:
##.###.#..
......####
#...#.#...
.###...#.#
##.#....#.
..##.#..#.
.##....#.#
#..#.....#
.#........
#######.#.

Tile 2503:
..#.#..#..
.......###
....#.....
####.#.##.
...##...#.
#..#..#..#
..........
.......#..
##..#..#.#
.#...#.###

Tile 2131:
##..#...##
#..#.#..##
..##...##.
.....#.#.#
...##....#
..##..#..#
..........
......#.#.
.#..#.#.##
#..##.##..

Tile 2129:
.#.#....#.
.......#.#
.....#..#.
.#......#.
###.#.#...
##.##.#...
...#.##...
......####
....#####.
#..#.##.#.

Tile 3643:
##..#.....
.##.##...#
#....#...#
#.###.....
####.#....
.#.....#..
##..###.#.
..#..#.#.#
#..##.#..#
#...##..##

Tile 1307:
#......#.#
##...#..#.
......##..
....#.#..#
#....##..#
......#.##
....#.#..#
#....#....
#..#..#...
#..#.#.#..

Tile 3989:
..###.#..#
###...#...
..#..#....
##....#.#.
##..#.#..#
.......##.
...#..##.#
#....#....
......#...
####.#..#.

Tile 2347:
.#########
##...#.#.#
..#.##...#
#..#..##..
#..#......
###......#
.##...#...
.####...#.
#...#.##..
.#.#####..

Tile 2801:
#.###.####
......#..#
...##.....
#.....#..#
...#......
........##
..###.####
#.#.#.##..
###...##..
##.##..##.

Tile 2543:
.....#..##
#....#.#..
....#.##.#
##.#..###.
.#.#.#..##
#.###.#..#
##..#..#.#
...###.#..
.....###.#
.##..#.#.#

Tile 2029:
##.##..###
.........#
#.#......#
#.#.#..#.#
.#.#.##.##
#.....####
...#.#....
#..##....#
....#.#...
###.#..###

Tile 1889:
#..#.#####
#.#.#...##
#.#...##.#
.....#...#
##...#.###
.....#....
#.#......#
#........#
...#......
.#..#####.

Tile 1787:
######.#.#
#.........
.#.#.#....
...#.....#
#..#.#..##
##.#...#..
...#.....#
##..#.#...
#.....##..
#...##.###

Tile 1619:
#.####....
#.#.#.##..
#...#....#
.#........
.......#..
#....#.#.#
.......#.#
.#.#..##.#
.##..##.#.
.#...##...

Tile 2617:
#..##.###.
.###...#..
..#.....#.
#....##...
#...#...##
.#.....#.#
#....#...#
...##..#.#
........##
...###...#

Tile 2879:
#.#.####..
.....#....
.###...#..
...#......
#.#.....#.
....#.....
.#.#.#.#.#
......#.#.
#.........
#.#..#####

Tile 1429:
..#.......
#.##.#.###
#......###
....#...#.
.....#.#.#
..#....###
#..#......
....#..#..
..#...#...
.#####.#..

Tile 2797:
##.#.#..#.
.....#.#.#
.......#.#
#...#.#...
.##.#.##.#
.##.....##
##......#.
##.#.#.#..
.....#...#
##.#######

Tile 3943:
..#.#.####
.#.......#
#..#.##.#.
.#..#....#
.#.##....#
#.#.#.#..#
......#...
#...##...#
#....##...
.##....#.#

Tile 3691:
##.#...###
.#.##...#.
##.##....#
.##.......
......#..#
...#..#..#
####.....#
#..####...
..#.....#.
...#.#....

Tile 3083:
#.###.....
#.#....#.#
#..#...###
...#..#..#
..#..#....
##...#.#.#
#.#.......
#.#..###..
##.#.....#
.#.##.....

Tile 1013:
#....#..##
#..#....##
#.#.#.#...
.....#.#.#
#........#
..#.....#.
.##..#.###
#..#..#.#.
........##
#.#.#.#.##

Tile 2089:
##.#.#..#.
#...#...##
#...#...##
..#....###
...#......
......##..
#......###
...#...###
.##...#.#.
.##...###.

Tile 2551:
###.######
####.#.###
.##.##...#
#..##.##.#
#.#.#.#..#
....#.#...
#.#....#..
##...#...#
#..#.#...#
..###..#.#

Tile 3607:
.#...##..#
####......
#..#.##..#
#..#......
###.....#.
#....###..
.........#
....##.#.#
......#..#
...#####..

Tile 1831:
##....##..
##.#......
#.#....#..
#.##..##..
...###....
##.#.#...#
#...#.#...
....#....#
##......##
.##.#..#.#

Tile 1697:
##..###.#.
#..#...###
#..#.....#
......#...
...#......
#........#
.#....####
#....#....
..##.###..
.#.##..#..

Tile 1621:
....##.##.
....#.#...
....#.#.#.
#.#...#..#
..#..#.#..
#........#
....##....
#.###.#..#
#....#..##
#..####...

Tile 1019:
.#.###..#.
###.......
#...#.#..#
..#.#.....
#.....###.
....#..#.#
.#.#.#.#..
#.........
#...#..#.#
..##..####

Tile 1471:
...#.####.
...##.##..
#.#.#..###
..##...###
##.###....
#....#...#
........##
#.##....#.
##.##..#.#
####.###..

Tile 3797:
..##...##.
#...#....#
###.###.##
##....##..
#.#.#...##
....##....
#.....#..#
#...#.#...
#.##.#..#.
..#.#.#.#.

Tile 1231:
##....#..#
#.........
#..#.#....
##...#....
#..#.#...#
###.##....
##.#....#.
....#.#..#
.#...#..##
#..#####.#

Tile 1667:
##.##.#..#
...#..#.##
..........
#.........
..#.##...#
....#.#.##
..#.##...#
##...###.#
###.......
#####..###

Tile 3719:
..##.##..#
...#......
#......#.#
#.#..###..
....#.#.#.
#.........
#........#
##.......#
#.....#..#
.##.#.####

Tile 1103:
.#..####.#
#....##.##
....###..#
#.........
#..#.....#
#......#..
.#..###.#.
.....#....
.......#.#
.##.##.###

Tile 2609:
..####..#.
#.....#..#
.#.####...
....#.....
#......#.#
.........#
.......#..
#.##.#....
..#.#.....
####.##..#

Tile 1117:
.#.#..##.#
#...#....#
#.#..####.
.#.......#
#...#.....
#...#....#
#..#.#.#..
.........#
.....#.##.
.#..####.#

Tile 3359:
##...#.#.#
..#.#....#
..#..##...
.......#..
.........#
#.#...###.
..#..#...#
#..#.....#
#..#.#..##
.###.#.#.#

Tile 2851:
.#....####
#...##...#
#..#.....#
#......#..
#.......#.
.###.#.#..
#....#..#.
###......#
#.##.#..#.
..#...#.##

Tile 2423:
.#..#.####
...#....#.
.....##...
.........#
........##
##.......#
........#.
#....#..##
#.#.......
#...##.##.

Tile 1579:
.##....#.#
##...#....
.#.##....#
..##.#.###
.#..#.#..#
....##..#.
..#..##..#
#.#..##...
.........#
.#.###.###

Tile 1361:
....#..##.
.###.#...#
...#.#....
#..#..#...
#.##......
#..#...#..
.##......#
.#...#.#.#
#........#
.#.#######

Tile 1171:
##.####..#
....#.#..#
#..#.....#
#.#......#
###...#..#
.##.#...##
##..##.#.#
#..#.#..##
#......#.#
....#.###.

Tile 3847:
##...#..#.
##.#.#..##
..........
#........#
..........
#........#
#..#.#....
.#.....#.#
....#.....
#.##.##.##

Tile 2557:
##..#.#...
.#.#..#...
####....#.
#...#.#...
...#.....#
..#..##..#
..###.#.##
...#..#..#
.....##...
##.####..#

Tile 2069:
..###....#
###..#.###
........##
#..#.#..#.
.........#
##.#.#.#.#
....#...#.
...#.#....
........#.
#.#.##..##

Tile 2179:
##...#.#.#
.##..#.##.
#..#..#...
..........
###.#....#
..........
#...#.....
#........#
....#...#.
##..####..

Tile 2659:
##..#...#.
#....##...
.....#.#.#
.......#..
##.#..#.#.
##........
#....###.#
#......#.#
.........#
#...#.##.#

Tile 1097:
.#..#.###.
.....#..##
....####..
.#.#.....#
......##.#
.#..####.#
.###....#.
..##.##...
###.##.#..
#..###...#

Tile 2143:
.##.....#.
......#..#
.#........
##......##
###....##.
#...#....#
..#..#..##
..##....#.
#.#.......
#..#####.#

Tile 3527:
##.#...#..
..#.###..#
.........#
.....##.##
.#.....###
#.#...#..#
.#.##.#.##
###.#..#..
.........#
#####.#.##

Tile 1063:
##.#.#.##.
##...#....
#.........
##..#.#..#
......##.#
##....#.#.
.....#..##
##.###...#
.....##.#.
#......#.#

Tile 2593:
#...####.#
##.####...
##.#.#..#.
#........#
#...#....#
.........#
.#..#..#.#
......#...
.#.......#
##..#####.

Tile 1753:
...#.#..#.
#.....#...
.#......##
.#....##.#
.#..#...##
..#..###..
###......#
#.#.#..###
###....##.
..#.##...#

Tile 2273:
#..##.###.
#.....#...
#...##....
..#....###
#.........
#####.#...
##..###..#
#...##....
#.#......#
##.##..##.

Tile 2731:
.#..#..##.
...#...#.#
...##.....
#..#..#..#
..........
.......###
...#..####
##.##....#
...#.#..#.
.##..#..##

Tile 2477:
..#.###.##
#..#.#....
.#.....#..
##..#.##..
...##....#
#.#.#...##
.##......#
..##..#..#
..#......#
#..#..#.##

Tile 2243:
.#..######
..#..####.
...##.#...
...##..#.#
..#.#...#.
#.#.#..#..
..#......#
#...#.#...
...##...##
##.#####.#

Tile 1451:
#.####.#.#
#........#
#.#......#
.#.......#
.........#
..........
#.........
.........#
#.........
..#..#..##

Tile 1289:
#....#...#
#.....#.#.
...#......
.#....###.
......#..#
##........
###.......
.#...#..#.
..#..#.#.#
#.#...###.

Tile 2927:
..##.#..#.
##.#.#..#.
..########
#....##...
...#.##...
#.........
#.....#.#.
#.##..#...
....#.#...
#.##.#..##

Tile 3433:
#.##...###
#.#..#..#.
.#.....#.#
#..#......
.....##...
#.##.....#
#..#....##
.....#..##
##..#.....
..###..###

Tile 1913:
#.##..#.##
#..####.#.
#.##..##..
....#..#..
.#.....#..
.#..#....#
#..####.##
..#..#...#
#.......##
.#.#####..

Tile 1567:
####...##.
#..#.....#
##..#...#.
##.#.#.#.#
..#.#.#...
##.#..#..#
.##...##.#
....#...#.
..###..#..
...#..####

Tile 2707:
.#.#.#..##
.#....#..#
#..#.#...#
......#.#.
.#..##...#
.#.##.....
#.#.....##
#.....#..#
#..#..##.#
#..#...#.#

Tile 3803:
#..#.#...#
.#........
##....###.
#.##....##
..#....#..
##.#..#.#.
....#..#.#
.#.......#
#..#...#.#
##.....###

Tile 2837:
.#..#####.
#.......##
###..#.###
#...#....#
..#..#.#..
....#....#
.#..##.##.
...#.....#
#...#..#.#
.##...##.#

Tile 2473:
#.##..##..
....#..#.#
.........#
#.....##..
....#.#..#
...#..#...
....#...##
.....###..
..#......#
##..###..#

Tile 3121:
...#.##..#
#........#
.##..##...
#.....#..#
......##.#
......#.#.
......#..#
........##
#...#....#
.##.#..#..

Tile 1637:
#....#....
....#..#..
#......#.#
#..#..#..#
#.......##
#..##.....
#....#...#
.#........
.##..##.##
.##...###.

Tile 1091:
..###....#
###...#...
..#......#
##........
.........#
.....##..#
###.##....
#..#....#.
.#.#.#....
.....#####

Tile 1453:
###...#.##
.##..#.#.#
.#.......#
.##...#..#
#..#...#..
.##...#..#
#....##..#
...##..#..
....#.....
..##....##

Tile 2861:
##....####
.....#...#
.##.#...#.
.....##..#
##..##..#.
#...#.##.#
##....##.#
#..#.#....
#####.#...
##.....#..

Tile 2677:
##..#..#.#
#....#....
.#..#....#
.###....#.
.#........
.....#.#.#
#..#.....#
#.##.##.##
..#.##..##
#..#..#...

Tile 3413:
..###.#..#
...##.....
...#..####
........#.
##.....#.#
......#..#
#...#..#.#
#.......#.
##..#.#.#.
#...#####.

Tile 1193:
#.#.#.#.#.
.#....##..
#.........
.......#.#
..#.#.#.##
...#...##.
##........
#..#....##
.........#
####...###

Tile 1949:
##..#..##.
.....#..#.
...##...##
####....##
.#..#.....
#........#
.##.#....#
...##.....
...#..####
###...####

Tile 3863:
#.#..#.###
#.#.....##
##....##.#
..###.###.
#.##....#.
...#.#.###
...#..#.##
..#......#
##...#...#
#..#.#.##.

Tile 1439:
#....#.###
.....#.#.#
.#.#...##.
.##.#....#
#....#....
....#.#..#
.....#...#
#...###...
.#..##..##
##..#.####

Tile 1129:
..########
..#.#.#...
....##....
.......#..
........##
..........
#..#.#.#..
##........
.........#
..##..####

Tile 2953:
.#.###.###
........#.
....#.#.##
..#.#....#
......#.##
...#....#.
###...#..#
....#.....
#.........
#...#...#.

Tile 3371:
##..#..###
##.....###
##....#..#
#.....#...
###.#..###
.#.#..#.##
##........
##.......#
#.##..#...
..##.####.

Tile 1399:
#.....#.#.
#......#..
.#..#....#
####..#..#
#..#.....#
##..#..#..
#.....#.##
.#..##..#.
.#..#....#
..#.#.###.

Tile 3911:
.#.....#.#
..#.....##
#...##....
#.........
..#.#...##
..#...#..#
.#.#....##
#..##....#
.#..##..##
#.#..#..#.

Tile 1699:
.####.####
..#..#....
#.....#.#.
...#..##..
##.#..#...
##..##....
#..#..#.#.
.###.#....
.....##.##
.#..#...##

Tile 3701:
.#.#.#.#..
..#.####.#
..##...###
......##.#
....#....#
.....#..##
...#.#.###
#..####.#.
...##....#
..###..###

Tile 1811:
.##.##.#..
....#....#
#......#.#
.....#..#.
#..#.#...#
.#.#.##..#
......#...
..##..#...
.....#...#
#####.#..#

Tile 2539:
...######.
#...#.###.
.#..#.....
.....#...#
.#...#...#
#.###..###
.######...
#...#.#.##
#.....##.#
...#..#.##

Tile 3517:
.#...#.##.
#....#..#.
#......#.#
##.##.....
...###..#.
#..#.#...#
#...#.#...
###.......
.#.......#
######.#..

Tile 2113:
#..###..#.
...#....##
##.......#
#....##..#
..#.#..###
#.#......#
#.....#..#
.#..#.#..#
...###....
##.#..#...

Tile 1009:
...##..###
..#.......
.#.....##.
##....#..#
##........
#....#..#.
.........#
#.#..#..##
....#.#..#
..#.##.#.#

Tile 1559:
###....#.#
.###...#.#
#.#.....#.
.#..#.#..#
....##.#.#
#.#..##.##
..#..##...
#.###.....
.#.#.##..#
##....####

Tile 2971:
...###...#
......##..
...#....##
.#.#.##..#
###.#.##.#
#..#...##.
..#.#...##
.....#.##.
.#........
##....#..#

Tile 1327:
.#..##...#
#.##.....#
.#.....#.#
...###...#
#....#....
.#.......#
.#.......#
#.........
.....#...#
..#######.

Tile 3217:
..###..#..
.#..#....#
......####
###....#.#
###...#...
.#...#....
........##
#.##.#.##.
#......#..
...#...#.#

Tile 1861:
####.####.
.#.....#..
###...#...
.##.#..##.
...#..#...
...#..#...
##..#...##
#...##..#.
#...#.....
##........

Tile 3593:
.##.##.###
....#...##
.#..#....#
#..##.##..
#..#...###
...#..##..
....#...##
###......#
..........
..#......#

Tile 3041:
###..###.#
....####..
....#..##.
#.#.....##
#..#...#..
#.......##
.#...#####
##.#...#.#
..#.###.#.
.####...##

Tile 2647:
#.###.####
#...#...##
.##....##.
#.#.#.....
#..#..##.#
##....#..#
..#....###
.....###..
........##
#.#.#....#

Tile 2437:
.##...#...
#.#...##.#
.#....##.#
#####...#.
#...##.#..
..#....#..
#.......#.
..#..#.#..
#.##...#.#
#.##..#..#

Tile 3709:
#######.##
###.#..##.
#.#...#..#
.#....####
##...#..#.
....#..#..
##........
#..##..#.#
.....#...#
..#.##...#

Tile 2039:
##.###..#.
...#.....#
..#...##.#
##.#.#...#
#....#..#.
#.####...#
...##...##
##...##..#
#.....##.#
####.#.#.#

Tile 3011:
...##.#...
.........#
###.####.#
#.......#.
.#.....#.#
..######..
#.....#..#
#........#
.##.##....
#.....###.

Tile 1151:
.##.#..#.#
#.##.....#
...#..#...
....##..##
###....###
##..#..#.#
#...#....#
..#....#..
...#.....#
#.#..#.#..'''

NESSIE = '''                  # 
#    ##    ##    ###
 #  #  #  #  #  #   '''.splitlines()

NESSIE_OFFSETS = [(i, j) for i in range(len(NESSIE)) for j in range(len(NESSIE[0])) if NESSIE[i][j] == '#']


def parse_tile(tile):
    lines = tile.splitlines()
    tile_id = int(re.findall(r'\d+', lines[0])[0])
    arr = []
    for line in lines[1:]:
        int_line = []
        for c in line:
            if c == '.': int_line.append(0)
            else: int_line.append(1)
        arr.append(int_line)
    shape = np.array(arr)

    return tile_id, shape


def make_tiles(inp):
    raw_tiles = inp.split('\n\n')
    parsed_tiles = []
    for t in raw_tiles:
        parsed_tiles.append(Tile(t))
    return parsed_tiles


class Tile:
    def __init__(self, raw_tile):
        parsed = parse_tile(raw_tile)
        self.id = parsed[0]
        self.shape = parsed[1]
        self.top, self.bottom, self.left, self.right = self._calc_borders()
        self.frozen = False
        
    def __str__(self):
        state = f"Tile ID: {self.id}."
        state += f'\n\n {self.shape}'
        return state
    
    def __repr__(self):
        return str(self.id)

    def _calc_borders(self):
        top = '0b' +  ''.join(map(str,  self.shape[0]))
        bottom = '0b' +  ''.join(map(str,  self.shape[-1]))
        left = '0b' +  ''.join(map(str,  self.shape[:,0]))
        right = '0b' +  ''.join(map(str,  self.shape[:,-1]))
        borders = (int(border, 2) for border in (top, bottom, left, right))
        return borders

    def rot_left(self):
        self.shape = np.rot90(self.shape, 1)
        self.top, self.bottom, self.left, self.right = self._calc_borders()

    def flip(self):
        self.shape = np.flipud(self.shape)        
        self.top, self.bottom, self.left, self.right = self._calc_borders()


def check_connection(A, B, side):
    if side == 'R' and A.right == B.left:
        return True
    elif side == 'L' and A.left == B.right:
        return True
    elif side == 'T' and A.top == B.bottom:
        return True
    elif side == 'B' and A.bottom == B.top:
        return True


def count_adj(check, tiles, side, edgecount):
    for tile in tiles:
        if check != tile:
            if check_connection(check, tile, side):
                edgecount[check.id] += 1
                return
            for _ in range(3):
                tile.rot_left()    
                if check_connection(check, tile, side):
                    edgecount[check.id] += 1
                    return
            tile.flip()
            if check_connection(check, tile, side):
                edgecount[check.id] += 1
                return
            else:
                for _ in range(3):
                    tile.rot_left()    
                    if check_connection(check, tile, side):
                        edgecount[check.id] += 1
                        return

def find_adj(check, tiles, side):
    for tile in tiles:
        if check != tile:
            if check_connection(check, tile, side): 
                tile.frozen = True
                return tile
            elif not tile.frozen:
                for _ in range(3):
                    tile.rot_left()    
                    if check_connection(check, tile, side): 
                        tile.frozen = True
                        return tile
                tile.flip()
                if check_connection(check, tile, side): 
                    tile.frozen = True
                    return tile
                else:
                    for _ in range(3):
                        tile.rot_left()    
                        if check_connection(check, tile, side): 
                            tile.frozen = True
                            return tile

def find_corners(tiles):
    edgecount = defaultdict(int)
    for check in tiles:
        #print(f"Checking {check.id}")
        for d in ("TBLR"):
            count_adj(check, tiles, d, edgecount)
    prod = 1
    for k in edgecount:
        if edgecount[k] == 2:
            prod *= k
    corners = [T for T in tiles if edgecount[T.id] == 2]
    return corners


def initiate_row(corners):
    for corner in corners:
        if find_adj(corner, tiles, 'R') and (len(corners) == 1 or find_adj(corner, tiles, 'B')):
            current_leftmost = corner
            next_row = find_adj(corner, tiles, 'B')
            break
    return current_leftmost, next_row


def make_row(init_tile, tiles, row):
    while True:
        next_right = find_adj(init_tile, tiles, 'R')
        if not next_right:
            break
        else:

            next_in_row = np.copy(next_right.shape[1:9, 1:9])
            row = np.concatenate((row, next_in_row), axis=1)
            init_tile = next_right
    return row


def generate_map(tiles, corners):
    rows = []

    while True:
        current_leftmost, next_row = initiate_row(corners)
        row_init = np.copy(current_leftmost.shape[1:9, 1:9])
        row = make_row(current_leftmost, tiles, row_init)
        corners = [next_row]
        rows.append(row)
        if not next_row:
            break

    full_map = rows[0]
    
    for row in rows[1:]:
        full_map = np.concatenate((full_map, row), axis=0)

    return full_map



inp = test
tiles = make_tiles(inp)
corners = find_corners(tiles)
map_monsters = generate_map(tiles, corners)
map_monsters = np.flipud(map_monsters)
map_monsters = np.rot90(map_monsters, 3)
print(map_monsters)

def find_monsters(map_monsters):
    monster_count = 0
    for i in range(len(map_monsters)-2):
        j = 0
        while j+20 <= len(map_monsters):
            monster_window = map_monsters[i:i+3, j:j+20]
            is_monster = True
            for coord in NESSIE_OFFSETS:
                x, y = coord
                if monster_window[x][y] != 1:
                    is_monster = False
                    break
            if is_monster:
                print("MONSTEEEER")
                monster_count += 1
            j += 1
    return monster_count

count = find_monsters(map_monsters)
print(count)

s = 0
for row in map_monsters:
    s += np.sum(row)
print(s - count * 15)


'''
nessie offsets
[(0, 18), (1, 0), (1, 5), (1, 6), (1, 11), (1, 12), (1, 17), (1, 18), (1, 19), (2, 1), (2, 4), (2, 7), (2, 10), (2, 13), (2, 16)]
'''

